@rendermode InteractiveWebAssembly

@using GeoCoordinate.NetStandard2;
@inject NavigationManager navigationManager;
@inject IGeolocationService geoService;

@if (Data?.Restaurant != null)
{
    <p>
        <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap" AlignItems="AlignItems.Start">
            <RadzenLabel Text="Restaurant" Component="codeRestaurant" Style="line-height:40px" />
            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.End">
                <RadzenDropDownDataGrid Value=@Data.Restaurant.Id
                                        Data=@Data.Restaurants
                                        Name="codeRestaurant"
                                        TextProperty="@nameof(RestaurantDisplay.FullName)"
                                        ValueProperty="@nameof(RestaurantDisplay.Id)"
                                        Style="width:350px"
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        Change="OnRestaurantChange"
                                        Disabled=@loading>
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(RestaurantDisplay.Departement)" Title="Dept." Width="70px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(RestaurantDisplay.Name)" Title="Nom" />
                    </Columns>
                </RadzenDropDownDataGrid>
                @if (Distance != null && !loading)
                {
                    <span class="distance">à @Distance km</span>
                }
                else
                {
                    <span class="distance">-</span>
                }
            </RadzenStack>
            @if (loading)
            {
                <RadzenProgressBarCircular Mode="ProgressBarMode.Indeterminate" ShowValue="false" Style="height:40px" />
            }
        </RadzenStack>

        @if (Data.Restaurant?.CatalogueUpdate != null)
        {
            if (!loading)
            {
                <span class="detail">Dernières mises à jour : catalogue le @ToLocalTime(Data.Restaurant.CatalogueUpdate) et offres le @ToLocalTime(Data.OffersUpdate)</span>
            }
        }
        else
        {
            <br />
            <span>Les données pour ce restaurant n'ont pas été chargées... 🥺</span>
        }
    </p>
}
else
{
    <p>Le restaurant demandé n'existe pas 🥺</p>
}

@code {

    GeoCoordinate? geoPosition;
    bool loading;

    [Parameter]
    public HeaderData? Data { get; set; }

    double? Distance
    {
        get
        {
            var restaurant = Data?.Restaurants.SingleOrDefault(r => r.Id == Data.Restaurant?.Id);
            if (restaurant != null && geoPosition != null)
            {
                return double.Round(new GeoCoordinate(restaurant.Lat, restaurant.Lng).GetDistanceTo(geoPosition) / 1000, 1);
            }

            return null;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await geoService.GetCurrentPositionAsync(this, "OnCurrentPositionChange");
        }
    }

    [JSInvokable]

    public void OnCurrentPositionChange(GeolocationPosition position)
    {
        geoPosition = new GeoCoordinate(position.Coords.Latitude, position.Coords.Longitude);
        StateHasChanged();

        if (navigationManager.Uri.Split('/', StringSplitOptions.RemoveEmptyEntries).Length < 4 && !navigationManager.Uri.Contains("data"))
        {
            var closestRestaurant = Data?.Restaurants.OrderBy(r => new GeoCoordinate(r.Lat, r.Lng).GetDistanceTo(geoPosition)).FirstOrDefault();
            if (closestRestaurant != null)
            {
                OnRestaurantChange(closestRestaurant.Id);
            }
        }
    }

    private void OnRestaurantChange(object change)
    {
        loading = true;
        var urlParts = navigationManager.Uri.Split('/', StringSplitOptions.RemoveEmptyEntries);
        var restaurantId = (string)change;

        if (urlParts.Length == 4)
        {
            navigationManager.NavigateTo($"{urlParts[2]}/{restaurantId}");
        }
        else
        {
            navigationManager.NavigateTo($"{(urlParts.Length <= 2 ? "/points" : $"/{urlParts[2]}")}/{restaurantId}");
        }
    }

    private string ToLocalTime(DateTime? date)
    {
        if (date == null)
        {
            return string.Empty;
        }

        return TimeZoneInfo.ConvertTimeFromUtc(date.Value, TimeZoneInfo.FindSystemTimeZoneById("Europe/Paris"))
            .ToString("dd/MM/yyyy à HH:mm");
    }
}
