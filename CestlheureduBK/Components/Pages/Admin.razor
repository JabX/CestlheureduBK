@page "/admin"
@using System.Globalization
@using System.Net
@using System.Net.Http.Headers
@using System.Text.RegularExpressions
@using CestlheureduBK.Services
@using GeoCoordinate.NetStandard2;
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject GetDataService getDataService;
@inject UpdateDataService updateDataService;

<PageTitle>C'est l'heure du BK ! - Chargement des données</PageTitle>

<RadzenStack AlignItems="AlignItems.Start">
    <h1>Administration</h1>

    <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap" AlignItems="AlignItems.Center">
        <RadzenLabel Text="Access Token pour l'API BK" Component="accessToken" />
        <RadzenTextBox @bind-Value=@accessToken Name="accessToken" Style="width:303px" />
    </RadzenStack>

    <RadzenButton Click="() => CallService(Service.Offers)" Disabled="loading" Text="Recharger les offres" />
    <RadzenButton Click="() => CallService(Service.Restaurants)" Disabled="loading" Text="Recharger les restaurants" />

    @if (loading)
    {
        <RadzenProgressBarCircular Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
    }

    <RadzenText class="@ClassName" Text="@message" />
    
    <h2 style="margin:0">Données chargées</h2>

    <RadzenTabs RenderMode="TabRenderMode.Client" >
        <Tabs>
            <RadzenTabsItem Text="Restaurants">
                <RadzenTable>
                    <RadzenTableHeader>
                        <RadzenTableHeaderRow>
                            <RadzenTableHeaderCell>Restaurant</RadzenTableHeaderCell>
                            <RadzenTableHeaderCell Style="width:170px">Dernière MàJ</RadzenTableHeaderCell>
                            <RadzenTableHeaderCell Style="width:60px" />
                        </RadzenTableHeaderRow>
                    </RadzenTableHeader>
                    <RadzenTableBody>
                        @foreach (var restaurant in restaurants)
                        {
                            <RadzenTableRow>
                                <RadzenTableCell>@restaurant.FullName</RadzenTableCell>
                                <RadzenTableCell>@restaurant.CatalogueUpdate.ToLocalDisplay()</RadzenTableCell>
                                <RadzenTableCell><RadzenButton Icon="refresh" Disabled="loading" Click="@(() => ReloadCatalogue(restaurant.Id))" /></RadzenTableCell>
                            </RadzenTableRow>
                        }
                    </RadzenTableBody>
                </RadzenTable>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Burgers Mystère">
                <span style="font-size:0.9em;font-style:italic">
                    Nombre total : <strong>@mysteryRolls.Count()</strong> / Montant économisé : <strong>@mysteryRolls.Sum(m => m.Gain).ToString("0.00 €")</strong>
                </span>
                <br />
                <br />
                <RadzenDataGrid Data="@MysteryRolls">
                    <Columns>
                        <RadzenDataGridColumn>
                            <HeaderTemplate>
                                <span class="header" @onclick="@(() => ToggleBSort("name"))">
                                    <span>Qui ?</span>
                                    @if (bSortBy == "name")
                                    {
                                        <RadzenIcon Icon="@(bAsc ? "arrow_drop_up" : "arrow_drop_down")" />
                                    }
                                </span>
                            </HeaderTemplate>
                            <Template Context="data">
                                @data.UserName
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn>
                            <HeaderTemplate>
                                <span class="header" @onclick="@(() => ToggleBSort("date"))">
                                    <span>Quand ?</span>
                                    @if (bSortBy == "date")
                                    {
                                        <RadzenIcon Icon="@(bAsc ? "arrow_drop_up" : "arrow_drop_down")" />
                                    }
                                </span>
                            </HeaderTemplate>
                            <Template Context="data">
                                Le @data.RollTime.ToLocalDisplay()
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Title="Quoi ?">
                            <Template Context="data">
                                @data.ProductName
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Title="Où">
                            <Template Context="data">
                                @data.RestaurantName
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn>
                            <HeaderTemplate>
                                <span class="header" @onclick="@(() => ToggleBSort("gain"))">
                                    <span>Prix</span>
                                    @if (bSortBy == "gain")
                                    {
                                        <RadzenIcon Icon="@(bAsc ? "arrow_drop_up" : "arrow_drop_down")" />
                                    }
                                </span>
                            </HeaderTemplate>
                            <Template Context="data">
                                <span>@data.ProductPrice.ToString("0.00 €")</span>
                                <span class="detail">(@data.Gain.ToString("0.00 €") gagné !)</span>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <h3>Palmarès</h3>
                <RadzenDataGrid Data="@Palmares">
                    <Columns>
                        <RadzenDataGridColumn Title="Qui ?">
                            <Template Context="data">
                                @data.UserName
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn>
                            <HeaderTemplate>
                                <span class="header" @onclick="@(() => ToggleSort("count"))">
                                    <span>Nombre</span>
                                    @if (pSortBy == "count")
                                    {
                                        <RadzenIcon Icon="@(pAsc ? "arrow_drop_up" : "arrow_drop_down")" />
                                    }
                                </span>
                            </HeaderTemplate>
                            <Template Context="data">
                                @data.Count
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn>
                            <HeaderTemplate>
                                <span class="header" @onclick="@(() => ToggleSort("gain"))">
                                    <span>Gain total</span>
                                    @if (pSortBy == "gain")
                                    {
                                        <RadzenIcon Icon="@(pAsc ? "arrow_drop_up" : "arrow_drop_down")" />
                                    }
                                </span>
                            </HeaderTemplate>
                            <Template Context="data">
                                @data.Gain.ToString("0.00 €")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn>
                            <HeaderTemplate>
                                <span class="header" @onclick="@(() => ToggleSort("ratio"))">
                                    <span>Gain moyen</span>
                                    @if (pSortBy == "ratio")
                                    {
                                        <RadzenIcon Icon="@(pAsc ? "arrow_drop_up" : "arrow_drop_down")" />
                                    }
                                </span>
                            </HeaderTemplate>
                            <Template Context="data">
                                @data.Ratio.ToString("0.00 €")
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenButton Click="() => CallService(Service.ResetDb)" Disabled Text="Tout réinitialiser" />
</RadzenStack>

@code {
    bool loading;
    string? accessToken;
    string? message;
    bool error;

    string bSortBy = "date";
    bool bAsc = false;

    string pSortBy = "count";
    bool pAsc = false;

    RestaurantDisplay[] restaurants = [];
    MysteryRollDisplay[] mysteryRolls = [];

    string ClassName => error ? "error" : "";

    MysteryRollDisplay[] MysteryRolls => ((bSortBy, bAsc) switch
    {
        ("name", true) => mysteryRolls.OrderBy(u => u.UserName).ThenByDescending(u => u.RollTime),
        ("name", false) => mysteryRolls.OrderByDescending(u => u.UserName).ThenByDescending(u => u.RollTime),
        ("date", true) => mysteryRolls.OrderBy(u => u.RollTime).ThenBy(u => u.UserName),
        ("date", false) => mysteryRolls.OrderByDescending(u => u.RollTime).ThenBy(u => u.UserName),
        ("gain", true) => mysteryRolls.OrderBy(u => u.Gain).ThenByDescending(u => u.RollTime),
        ("gain", false) => mysteryRolls.OrderByDescending(u => u.Gain).ThenByDescending(u => u.RollTime),
        _ => mysteryRolls.AsEnumerable()
    }).ToArray();

    UserPalmares[] Palmares 
    {        
        get 
        {
            var users = mysteryRolls.Where(mr => mr.UserName != "Anonyme")
                .GroupBy(c => c.UserName)
                .Select(g => new UserPalmares(g.Key, g.Count(), g.Sum(mr => mr.Gain)));

            return ((pSortBy, pAsc) switch
            {
                ("count", true) => users.OrderBy(u => u.Count).ThenByDescending(u => u.Gain),
                ("count", false) => users.OrderByDescending(u => u.Count).ThenByDescending(u => u.Gain),
                ("gain", true) => users.OrderBy(u => u.Gain).ThenBy(u => u.Ratio),
                ("gain", false) => users.OrderByDescending(u => u.Gain).ThenByDescending(u => u.Ratio),
                ("ratio", true) => users.OrderBy(u => u.Ratio).ThenBy(u => u.Gain),
                ("ratio", false) => users.OrderByDescending(u => u.Ratio).ThenByDescending(u => u.Gain),
                _ => users
            }).ToArray();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        restaurants = (await getDataService.GetRestaurants()).Where(r => r.CatalogueUpdate != null)
            .OrderByDescending(r => r.CatalogueUpdate)
            .ToArray();

        mysteryRolls = (await getDataService.GetMysteryRolls()).ToArray();
    }

    private void ToggleBSort(string field)
    {
        bAsc = !bAsc;
        bSortBy = field;
    }

    private void ToggleSort(string field)
    {
        if (pSortBy != field && field == "")
        {
            pAsc = false;
        }
        else
        {
            pAsc = !pAsc;
        }
        pSortBy = field;
    }

    private async Task CallService(Service service)
    {
        if (service == Service.Restaurants || !string.IsNullOrEmpty(accessToken))
        {
            message = null;
            error = false;
            loading = true;

            (message, error) = service switch
            {
                Service.Offers => await updateDataService.ReloadOffers(accessToken),
                Service.Restaurants => await updateDataService.ReloadRestaurants(),
                Service.ResetDb => await updateDataService.ResetDb(accessToken),
                _ => default
            };

            loading = false;
        }
    }

    private async Task ReloadCatalogue(string resturantId)
    {
        message = null;
        error = false;
        loading = true;

        (message, error) = await updateDataService.ReloadCatalogue(resturantId);
        await OnInitializedAsync();

        loading = false;
    }

    enum Service
    {
        Offers,
        Restaurants,
        ResetDb
    }

    record UserPalmares(string UserName, int Count, double Gain)
    {
        public double Ratio => Gain / Count;
    }
}
