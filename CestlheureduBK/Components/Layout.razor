@using CestlheureduBK.Services
@inherits LayoutComponentBase
@inject ThemeService themeService;
@inject NavigationManager navigationManager;
@inject UserService userService;
@inject GetDataService getDataService;

<RadzenLayout>
    <RadzenHeader>
        <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" Gap="0">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="width:100%">
                <RadzenText Text="C'est l'heure du BK !" TextStyle="TextStyle.H5" />
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="18px">
                    @if (userService.IsAuthenticated)
                    {
                        <RadzenLink title="@userService.Email" Icon="person" Text="@userService.Name" Path="./me" />
                    }
                    else
                    {
                        <RadzenLink Icon="login" Text="Login" Path="./login" />
                    }
                    <ThemeSwitcher />
                </RadzenStack>
            </RadzenStack>
            <RadzenPanelMenu>
                <RadzenPanelMenuItem Path=@($"/points{RestaurantId}") Text="Couronnes" Icon="star" />
                <RadzenPanelMenuItem Path=@($"/carte{RestaurantId}") Text="Carte" Icon="menu_book" />
                <RadzenPanelMenuItem Path=@($"/snacks{RestaurantId}") Text="Snacks" Icon="fastfood" />
                <RadzenPanelMenuItem Path=@($"/mystere/{burgerMystereMonth}{RestaurantId}") Text="Burger Mystère" Icon="question_mark" />
            </RadzenPanelMenu>
        </RadzenStack>
    </RadzenHeader>
    <RadzenBody>
        @Body
    </RadzenBody>
</RadzenLayout>

@code {
    [CascadingParameter]
    HttpContext? HttpContext { get; set; }

    string burgerMystereMonth = string.Empty;

    string RestaurantId
    {
        get
        {
            var lastPart = navigationManager.Uri.Split('/').LastOrDefault();
            if (lastPart?.StartsWith("K") ?? false)
            {
                return $"/{lastPart}";
            }

            return string.Empty;
        }
    }

    protected async override Task OnInitializedAsync()
    {
        if (HttpContext != null && HttpContext.Request.Cookies.TryGetValue("theme", out var cookie) && cookie != null)
        {
            themeService.SetTheme(cookie);
        }

        var burgerMysteresMonths = await getDataService.GetBurgerMystereMonths();
        var currentMonth = DateTime.Now.ToString("yyyy-MM");
        burgerMystereMonth = burgerMysteresMonths.FirstOrDefault(b => b.StartsWith(currentMonth)) ?? currentMonth;
    }
}